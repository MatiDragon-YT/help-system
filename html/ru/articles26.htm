<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<HTML><HEAD><TITLE>Создание миссии. Часть 3</TITLE>
<link rel="stylesheet" type="text/css" href="../../style/style.css">
<META http-equiv=Content-Type content="text/html; charset=windows-1251">
</HEAD>
<BODY topMargin=0 >
<TABLE
style="BORDER-RIGHT: medium none; BORDER-TOP: medium none; BORDER-LEFT: medium none; BORDER-BOTTOM: #c0c0c0 1px solid"
height=121 cellSpacing=0 cellPadding=0 width=640>
  <TBODY>
  <TR>
    <TD vAlign=top width="100%"><IMG
      src="img/ru/logo2.jpg" width="640" height="121" border=0 class="conthdr" ></TD>
</TR></TBODY></TABLE>
<TABLE cellSpacing=0 cellPadding=0 width=640 border=0>
  <TBODY>

  <TD width="100%" height="100%" vAlign=top>
   <DIV><IMG
      src="img/ru/old/articles/articles.png" width="640" height="33"></DIV>


      <TABLE cellSpacing=0 cellPadding=0 width="100%">
        <TBODY>
        <TR>
          <TD width=5><IMG height=36
            src="img/ru/mtdl.png" width=5></TD>
          <TD class=ntitle vAlign=top
          background="mtdbg.png" height=36>Создание миссии. Часть 3 </TD>
          <TD width=5><IMG height=36
            src="img/ru/mtdr.png"
      width=20></TD></TR></TBODY></TABLE>
      <TABLE cellSpacing=0 cellPadding=0 width="100%">
        <TBODY>
        <TR>
          <TD width=5 background="ltd.gif"></TD>
          <TD class=news vAlign=top>
	[продолжение.  <a href="articles11.htm">начало читайте здесь </a>]
	<p>Ну что ж пришло время подробно рассмотреть устройство кода  миссии. <br>
  Код миссии состоит из 4 блоков:<br>
  1. блок запуска<br>
  2. блок успешного прохождения <br>
  3. блок провала<br>
  4. блок завершения миссии  </p>
	<p><span class="general1-reservedword">Блок запуска</span> выглядит следующим образом: </p>
    <div class="mycode5">
<span class="general1-label">:MISSION </span>            <br>
  <span class="general1-reservedword">thread</span> <span class="general1-string">'MISSION' </span><br>
  <span class="general1-reservedword">gosub</span> <span class="general1-label">@MissionStart</span><br>
  <span class="general1-reservedword">if <br>
  wasted_or_busted <br>
  jf</span> <span class="general1-label">@MissionCleanup</span><br>
  <span class="general1-reservedword">gosub</span> <span class="general1-label">@MissionFailed</span></div>
<p>Командой <span class="general1-reservedword">thread</span>  <span class="general1-string">'MISSION'</span>  - даем имя нашему потоку, о полезности этого  действия рассказывать не буду, это отдельная тема. Командой <span class="general1-reservedword">gosub</span> <span class="general1-label">@MissionStart</span> мы  и осуществляем переход к коду самой миссии, с последующим возвратом на  следующую после <span class="general1-reservedword">gosub</span>  стоку. О работе <span class="general1-reservedword">gosub</span> и  вариантах переходов смотрите <a href="articles27.htm">здесь</a>.<br>
  <br>
  Итак </p>
<div class="mycode5">
<span class="general1-reservedword">gosub</span>  <span class="general1-label">@MissionStart</span><br>
<br>
. . . .<br><br>
<span class="general1-label">:MissionStart</span><br>
&lt; тело миссии&gt;<br>
<span class="general1-reservedword">return</span><span class="general1-comment"> //– возвращаемся на следующую после gosub @MissionStart строку. </span></div>
<p>Сам <span class="general1-reservedword">return</span> может быть как из <span class="general1-reservedword">блока успешного прохождения</span>,  так и из<span class="general1-reservedword"> блока провала</span>.</p>
<p class="general1-reservedword">Блок успешного прохождения</p>
<p>Этот блок выполняется тогда, когда задание миссии выполнено.<br>
  Обычно в этом блоке выводится надпись об успешном  прохождении миссии, увеличивают количество денег и т.д. Самый простой вариант  выглядит так:</p>
<div class="mycode5">
<span class="general1-label">:MissionPassed </span><br>
  01E3:  text_1number_styled <span class="general1-string">'M_PASSD'</span> <span class="general1-number">0 5000</span> ms <span class="general1-number">1</span> <span class="general1-comment">// MISSION  PASSED! </span><br>
  <span class="general1-comment">// выводим надпись об успешном прохождении миссии</span><br>
  0394: play_music <span class="general1-number">1</span> <span class="general1-comment">// проигрываем музыку</span><br>
  <span class="general1-reservedword">return </span> <span class="general1-comment">// возвращаемся на следующую после gosub @MissionStart строку</span></div>
<p class="general1-reservedword">Блок провала</p>
<p>Если же поставленное задание в миссии не выполнено, то в  этом случае и применяется блок провала. А также этот блок выполняется в случае  смерти или ареста игрока.</p>
<div class="mycode5">
<span class="general1-label">:MissionFailed</span><br>
  00BA:  text_styled <span class="general1-string">'M_FAIL' </span><span class="general1-number">5000</span> ms <span class="general1-number">1</span>  <span class="general1-comment">// ~r~MISSION FAILED!</span><br>
  <span class="general1-comment">// выводим надпись о провале миссии</span><br>
  <span class="general1-reservedword">create_thread</span> <span class="general1-label">@START</span><br>
  <span class="general1-comment">// запускаем стартер нашей миссии</span><br>
  <span class="general1-reservedword">return</span>  <span class="general1-comment">//  возвращаемся на следующую после gosub  @MissionStart строку  </span></div>
<p>Для того чтобы после провала миссии иметь возможность еще  раз пройти нашу миссию необходимо в блок провала включить <span class="general1-reservedword">create_thread</span> <span class="general1-label">@START</span>  – запуск стартера миссии, при условии, что стартер у нас рассчитан на запуск  одной миссии. При последовательном запуске миссий этого делать не нужно. О  стартерах миссий смотреть<a href="articles26.htm"> здесь</a>.</p>
<p>Итак, мы выяснили, что при любом варианте (провал или  успешное прохождение) все равно возвращаемся на следующую после <span class="general1-reservedword">gosub</span> <span class="general1-label">@MissionStart</span>  строку. Где собственно проверяется, убит или арестован игрок </p>
<div class="mycode5">
<span class="general1-reservedword">gosub</span> <span class="general1-label">@MissionStart</span><br>
  <span class="general1-reservedword">if <br>
  wasted_or_busted   </span><span class="general1-comment">// убит или арестован </span><span class="general1-reservedword"><br>
  jf</span> <span class="general1-label">@MissionCleanup </span> <span class="general1-comment">// если нет, то переходим на  блок завершения миссии </span> <br>
  <span class="general1-reservedword">gosub</span> <span class="general1-label">@MissionFailed</span><br>
  <span class="general1-comment">// если убит или арестован, то переходим на блок провала с   возвратом на<br>
  // следующую после gosub @MissionFailed строку</span></div>
<p class="general1-reservedword">Блок завершения миссии  </p>
<div class="mycode5">
<span class="general1-label">:MissionCleanup</span><br>
  <span class="general1-variable">$ONMISSION</span>  = <span class="general1-number">0</span> <span class="general1-comment">// integer values </span><br>
  <span class="general1-reservedword">mission_cleanup <br>
  end_thread</span></div>
<p>Этот блок необходим для корректного завершения миссии.<br>
  Команда <span class="general1-reservedword">mission_cleanup</span>  высвобождает память от всего созданного на  протяжении миссии, уничтожаем всех актеров, машины и пр. </p>
<p>У нас уже есть рабочая заготовка миссии, но самой миссии,  как таковой нет. Напишем простенькую миссию, суть которой успеть доехать до  указанного места. <br>
  Для начала создаем автомобиль и поместим игрока около этого  авто.</p>
<div class="mycode5">
<span class="general1-label">:MissionStart</span><br>
  <span class="general1-class">Model</span>.<span class="general1-command">Load</span>(<span class="general1-model">#BFINJECT</span>)<br>
  038B:  load_requested_models <br>
<br>
<span class="general1-label">:MissionStart_27</span><br>
  <span class="general1-reservedword">wait </span><span class="general1-number">0</span><span class="general1-reservedword"> <br>
  if </span><br>
  <span class="general1-class">Model</span>.<span class="general1-command">Available</span>(<span class="general1-model">#BFINJECT</span>)<br>
  jf  @MissionStart_27 <br>
  01EB:  set_traffic_density_multiplier_to <span class="general1-number">0.0 </span><br>
  <span class="general1-comment">// отключаем трафик</span><br>
  03DE:  set_pedestrians_density_multiplier_to<span class="general1-comment"> 0.0</span><br>
  <span class="general1-comment">// убираем появление  случайных актеров </span><br>
  <span class="general1-class">Player</span>.<span class="general1-command">CanMove</span>(<span class="general1-variable">$PLAYER_CHAR</span>)  =<span class="general1-reservedword"> False</span><br>
  <span class="general1-comment">// делаем игрока неподвижным</span><br>
  02A3:  toggle_widescreen <span class="general1-number">1</span> <span class="general1-comment">// включаем широкий экран </span><br>
  <span class="general1-variable">$car</span> =  <span class="general1-class">Car</span>.<span class="general1-command">Create</span>(<span class="general1-model">#BFINJECT</span>,<span class="general1-number"> 2636.431</span>, <span class="general1-number">-1730.885</span>, <span class="general1-number">10.7281</span>)<br>
  <span class="general1-class">Car</span>.<span class="general1-command">Angle</span>(<span class="general1-variable">$car</span>)  =<span class="general1-number"> 89.3845</span><br>
  <span class="general1-class">Actor</span>.<span class="general1-command">PutAt</span>(<span class="general1-variable">$PLAYER_ACTOR</span>,  <span class="general1-number">2634.789</span>, <span class="general1-number">-1722.628</span>, <span class="general1-number">10.8984</span>)<br>
  <span class="general1-class">Actor</span>.<span class="general1-command">Angle</span>(<span class="general1-variable">$PLAYER_ACTOR</span>)  = <span class="general1-number">179.9178</span><br>
  04E4:  unknown_refresh_game_renderer_at <span class="general1-number">2634.789 -1722.628 </span><br>
  <span class="general1-comment">//делаем прорисовку местности в указанных координатах</span><br>
  <span class="general1-class">Camera</span>.<span class="general1-command">SetAtPos</span>(<span class="general1-number">2634.789</span>,  <span class="general1-number">-1722.628</span>, <span class="general1-number">11.8984</span>)<br>
  <span class="general1-comment">// и устанавливаем камеру</span><br>
  <span class="general1-class">Camera</span>.<span class="general1-command">SetBehindPlayer</span><br>
  <span class="general1-reservedword">wait</span> <span class="general1-number">500 </span><br>
  <span class="general1-reservedword">fade</span> <span class="general1-number">1&nbsp;500</span></div>
<p>Поскольку это миссия, то нам необходимо объяснить играющему  цель миссии, то есть, то что нужно сделать чтобы ее пройти. Для этого выводим  текст на экран, а чтобы во время показа текста нам не мешали ни случайный  транспорт ни актеры, мы и отключаем их появление. Нужные нам тексты находятся в  разных GXT таблицах  поэтому приходится для того чтобы текст отображался на экране загружать разные  таблицы для каждого предложения. </p>
<div class="mycode5">
<span class="general1-label">:MissionStart_37</span><br>
  <span class="general1-reservedword">wait</span> <span class="general1-number">0 </span><br>
  054C:  use_GXT_table <span class="general1-string">'GARAGE1'  </span><br>
  <span class="general1-comment">//загружаем таблицу 'GARAGE1' </span><br>
  00BC:  show_text_highpriority GXT <span class="general1-string">'GAR1_22'</span> time <span class="general1-number">3000</span> flag<span class="general1-number"> 1  </span><br>
  <span class="general1-reservedword">wait </span><span class="general1-number">3000</span> <br>
  03D5:  remove_text <span class="general1-string">'GAR1_22'</span>  <br>
  054C:  use_GXT_table<span class="general1-string"> 'BLOOD' </span><br>
  00BC:  show_text_highpriority GXT <span class="general1-string">'BLOD_01'</span> time<span class="general1-number"> 5000</span> flag <span class="general1-number">1 </span> <br>
  <span class="general1-reservedword">wait </span><span class="general1-number">5000</span> <br>
  03D5:  remove_text <span class="general1-string">'BLOD_01'</span>  <br>
  00BC:  show_text_highpriority GXT <span class="general1-string">'BLOD_02'</span> time<span class="general1-number"> 5000</span> flag <span class="general1-number">1 </span> <br>
  <span class="general1-reservedword">wait</span> <span class="general1-number">5000 </span><br>
  03D5:  remove_text <span class="general1-string">'BLOD_02'  </span><br>
  <span class="general1-class">Player</span>.<span class="general1-command">CanMove</span>(<span class="general1-variable">$PLAYER_CHAR</span>)  = <span class="general1-comment">True</span><br>
  <span class="general1-comment">// игроком можно управлять</span><br>
  02A3:  toggle_widescreen <span class="general1-number">0</span> <span class="general1-comment">//отключаем  широкий экран</span></div>
<p>Теперь, когда показ текста закончен нам необходимо проверить  находится ли игрок в автомобиле, а затем уже создавать checkpoint и запускать  таймер.</p>
<div class="mycode5">
  <pre>
<span class="general1-label">:MissionStart_39</span>
<span class="general1-reservedword">wait </span><span class="general1-number">0 </span><span class="general1-reservedword">
if </span>
  <span class="general1-class">Actor</span>.<span class="general1-command">InCar</span>(<span class="general1-variable">$PLAYER_ACTOR</span>, <span class="general1-variable">$car</span>)
<span class="general1-reservedword">jf</span> <span class="general1-label"> @MissionStart_39</span>
<span class="general1-class">Car</span>.<span class="general1-command">LockInCurrentPosition</span>(<span class="general1-variable">$car</span>)  = <span class="general1-reservedword">True</span>
<span class="general1-comment">// Блокируем автомобиль </span>
<span class="general1-reservedword">wait </span><span class="general1-number">2000 </span>
<span class="general1-variable">$TIME</span>  = <span class="general1-number">20000</span> <span class="general1-comment">//миллисекунды </span>
<span class="general1-comment">//установим лимит времени в 20 секунд</span>
03C3:  set_timer_to<span class="general1-variable"> $TIME</span> type <span class="general1-number">1</span> GXT <span class="general1-string">'TIMER' </span>
<span class="general1-comment">//будет обратный отсчет времени</span>
06D5:  <span class="general1-variable">$r_checkpoint</span> = create_racing_checkpoint_at <span class="general1-number">2192.036 -1732.899 13.0168</span>  point_to<span class="general1-number"> 0.0 0.0 0.0</span> type <span class="general1-number">1</span> radius <span class="general1-number">6.0 </span>
018A:  <span class="general1-variable">$checkpoint</span> = create_checkpoint_at <span class="general1-number">2192.036 -1732.899 13.0168 </span>
01EB:  set_traffic_density_multiplier_to <span class="general1-number">1.0 </span>
03DE:  set_pedestrians_density_multiplier_to <span class="general1-number">1.0 </span>
<span class="general1-comment">// включаем появление транспорта и пешеходов</span>
<span class="general1-class">Car</span>.<span class="general1-command">LockInCurrentPosition</span>(<span class="general1-variable">$car</span>) = <span class="general1-reservedword">False</span></pre>
</div>
<p>Итак таймер запущен, теперь необходимо проверить находится  ли автомобиль в указанных координатах и не закончилось ли время. </p>
<div class="mycode5">
  <pre>
<span class="general1-label">:MissionStart_45</span>
<span class="general1-reservedword">wait </span><span class="general1-number">0</span><span class="general1-reservedword">
if </span>
  <span class="general1-variable">$TIME</span> &gt; <span class="general1-number">0  </span>
<span class="general1-reservedword">jf </span><span class="general1-label">@MissionFailed</span> <span class="general1-comment">//если время истекло, то миссия провалена</span>
<span class="general1-reservedword">if </span>
  0100:   actor <span class="general1-variable">$PLAYER_ACTOR</span> in_sphere <span class="general1-number">2192.036  -1732.899 13.0168</span> radius<span class="general1-number"> 6.0 6.0 6.0 </span>sphere <span class="general1-number">0</span> in_car
<span class="general1-reservedword">jf</span>  <span class="general1-label">@MissionStart_45 </span>
<span class="general1-reservedword">wait</span> <span class="general1-number">50 </span>
<span class="general1-class">Car</span>.<span class="general1-command">LockInCurrentPosition</span>(<span class="general1-variable">$car</span>)  = <span class="general1-reservedword">True</span>
014F:  stop_timer <span class="general1-variable">$TIME</span> <span class="general1-comment"> // останавливаем таймер
//удаляем модель, маркер, racing_checkpoint </span>
06D6:  disable_racing_checkpoint <span class="general1-variable">$r_checkpoint </span>
<span class="general1-class">Marker</span>.<span class="general1-command">Disable</span>(<span class="general1-variable">$checkpoint</span>)
<span class="general1-class">Model</span>.<span class="general1-command">Destroy</span>(<span class="general1-model">#BFINJECT</span>)
<span class="general1-class">Car</span>.<span class="general1-command">RemoveReferences</span>(<span class="general1-variable">$car</span>)
<span class="general1-comment">//автомобиль переводим в разряд случайного транспорта</span>
<span class="general1-class">Car</span>.<span class="general1-command">LockInCurrentPosition</span>(<span class="general1-variable">$car</span>)  = <span class="general1-reservedword">False</span>
<span class="general1-reservedword">jump</span> <span class="general1-label">@MissionPassed</span>

<span class="general1-label">:MissionPassed</span>
01E3:  show_text_1number_styled GXT <span class="general1-string">'M_PASSS'</span> number <span class="general1-number">2000</span> time <span class="general1-number">5000</span> style <span class="general1-number">1</span>
<span class="general1-comment">// MISSION PASSED!~n~~w~$~1~~n~~w~RESPECT +</span>
0998:  add_respect <span class="general1-number">3</span> <span class="general1-comment">// увеличим респект</span>
<span class="general1-class">Player</span>.<span class="general1-command">Money</span>(<span class="general1-variable">$PLAYER_CHAR</span>)  += <span class="general1-number">2000</span>
<span class="general1-comment">// заплатим игроку за труды</span>
0394:  play_music <span class="general1-number">1 </span>
<span class="general1-reservedword">return </span>
<span class="general1-comment">// возвращаемся на следующую после gosub @MissionStart строку</span>

<span class="general1-label">:MissionFailed</span>
00BA:  show_text_styled GXT <span class="general1-string">'M_FAIL'</span> time <span class="general1-number">5000</span> style <span class="general1-number">1</span>   <span class="general1-comment">// ~r~MISSION FAILED!</span>
014F:  stop_timer <span class="general1-variable">$TIME</span>
<span class="general1-comment">// останавливаем таймер</span>
<span class="general1-comment">//удаляем модель, маркер, racing_checkpoint </span>
06D6:  disable_racing_checkpoint <span class="general1-variable">$r_checkpoint </span>
<span class="general1-class">Marker</span>.<span class="general1-command">Disable</span>(<span class="general1-variable">$checkpoint</span>)
<span class="general1-class">Model</span>.<span class="general1-command">Destroy</span>(<span class="general1-model">#BFINJECT</span>)
<span class="general1-class">Car</span>.<span class="general1-command">RemoveReferences</span>(<span class="general1-variable">$car</span>)
<span class="general1-class">Car</span>.<span class="general1-command">LockInCurrentPosition</span>(<span class="general1-variable">$car</span>)  = <span class="general1-reservedword">False</span>
<span class="general1-reservedword">create_thread</span>  <span class="general1-label">@START </span>

<span class="general1-comment">// запуск стартера миссии </span>
<span class="general1-reservedword">return</span>
<span class="general1-comment">// возвращаемся на следующую после gosub @MissionStart строку</span></pre></div>
<p>Теперь у нас уже полноценная простенькая миссия, остается  только скомпилировать файл и начать новую игру.<br>
  <strong>Пример миссии смотрите</strong> <a href="examples/MissionStart.txt" target="_blank">здесь</a>.</p>
</TD>
          <TD width=5
        background="rtd.gif"></TD></TR></TBODY></TABLE>
      <TABLE cellSpacing=0 cellPadding=0 width="100%">
        <TBODY>
        <TR>
          <TD width=5><IMG height=20
            src="img/ru/mtdlbot.png" width=5 border=0></TD>
          <TD align=left
            background="mtdbgbot.png"></TD>
          <TD class=ninfo align=right
          background="mtdbgbot.png">&nbsp;
            </TD>
          <TD width=5><IMG height=20
            src="img/ru/mtdrbot.png" width=5
        border=0></TD></TR></TBODY></TABLE></DIV>
<BR><BR></TD></TR><td width="100%"></TBODY></TABLE>
</TABLE></body></html>
